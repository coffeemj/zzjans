---
layout: post
title: "🧮 TDD에 대해서"
date: 2021-08-28 17:50:00 +0900
categories: TDD
---

TDD를 적용하기 전 조사했었던 자료들을 나중에 참고하기 위해 정리해보았다.

## 테스트 종류

### 단위 테스트

- 작은 단위(주로 모듈 단위)를 전체 어플리케이션에서 떼어 내어 분리된 환경에서 테스트하는 것을 말한다.
- 모킹(Mocking) : 의존성 있는 모듈을 제어하기 위해 모의 객체를 사용하는 것
- 모의 객체를 사용하면 각 모듈이 실제로 잘 연결되어 상호작용하는지에 대해서는 검증하지 못한다.
- 각 모듈의 사소한 API변경에도 영향을 받아서 작은 단위의 리팩토링에도 쉽게 깨지는 문제가 있다.

### 통합 테스트

- 보통 두 개 이상의 모듈이 실제로 연결된 상태의 테스트를 말한다.
- 여러 모듈이 동시에 상호작용하는 것을 테스트하기 때문에 단위 테스트에 비해 모의 객체의 사용이 적다.
- 넓은 범위에서의 API 변경에만 영향을 받기 때문에 단위 테스트와 비교해 리팩토링할 때 쉽게 깨지지 않는 장점이 있다.
- 단위 테스트에 비해 테스트가 번거롭고 테스트 중복이 발생할 확률이 높다는 단점이 있다.

### E2E 테스트

- 개발자 관점이 아닌 실제 사용자 관점에서의 테스트를 말한다.
- 기능(Functional) 혹은 UI(User Interface) 테스트라고 불리기도 한다.
- 사용자의 실행환경과 거의 동일한 환경에서 테스트를 진행해서 실제 상황에서 발생할 수 있는 에러를 사전에 발견할 수 있다.
- 브라우저를 외부에서 직접 제어할 수 있어 브라우저 크기변경, 실제 키보드 입력 등 자바스크립트 API만으로 제어할 수 없는 것들을 테스트할 수도 있다.
- 단위 테스트나 통합 테스트에 비해 실행속도가 느리다.
- 샌드박스 환경에서의 테스트가 아니기에 실행환경의 예상치 못한 문제들(네트워크 오류, 프로세스 대기로 인한 타임아웃 등)로 인해 테스트가 실패하기도 해서 테스트를 100% 신뢰할 수 없는 문제가 발생하기도 한다.

## 자바스크립트 테스트 도구

### 테스트 러너

테스트 러너는 테스트를 구동할 수 있는 환경을 제공해준다. 테스트 파일을 읽어들여 작성한 코드를 실행하고, 그 결과를 특정한 형식으로 출력해준다. 테스트 수행결과는 리포터(Reporter)를 지정해서 원하는 형태로 출력할 수 있다. 부가적으로 테스트코드나 소스코드가 변경된 경우 영향을 받는 테스트를 자동으로 재실행해주는 왓쳐(Watcher) 등의 기능도 제공한다.

예전엔 자바스크립트를 실행할 수 있는 환경이 브라우저에 한정되어 있었기 때문에, 작성된 테스트코드를 직접 브라우저에서 실행한 후 웹페이지나 브라우저 콘솔을 통해서만 결과를 확인할 수 있었다. 하지만 Node.js의 등장으로 브라우저 없이도 자바스크립트 코드를 쉽게 실행할 수 있게 되었고, 덕분에 테스트 러너와 같은 도구를 사용해 이러한 과정을 자동화할 수 있게 되었다.

- 브라우저에서 직접 코드를 실행하는 테스트러너 (예: Karma)
- Node.js 환경에서 코드를 실행하는 테스트러너 (예: Jest)

Node.js 기반 테스트러너들은 굳이 러너의 실행환경과 코드실행환경을 나눌 필요가 없어서 대부분 프레임워크와 통합된 형태로 제공된다.

### 테스트 프레임워크

테스트 프레임워크는 사용자가 테스트코드를 작성할 수 있는 기반을 제공해주는 자바스크립트 도구이다.  프레임워크가 제공하는 함수들을 사용해서 테스트코드를 작성하면, 프레임워크가 테스트코드를 자동으로 실행한 후 성공 및 실패에 대한 결과를 반환해준다. 대포적인 테스트 프레임워크로는 Mocha, Jasmine, AVA 등이 있으며, 최근에는 Jest가 빠른 속도로 점유율을 높여가고 있다.

테스트코드는 주로 테스트를 위한 초기화와 단언으로 이루어진다.

#### 단언(assertion)

개별 테스트가 통과하기 위한 조건을 명확하게 기술하기 위해 사용된다. 

보통은 테스트 프레임워크에서 다양한 방식의 단언 API를 기본 제공하고 있으며, Mocha의 경우에만 [Chai](https://www.chaijs.com/)와 같은 별도의 단언 라이브러리를 사용하도록 권장하고 있다.

초기의 단언 라이브러리들은 [JUnit](https://junit.org/junit5/)과 유사한 방식의 API를 많이 따랐지만, 최근에 가장 많이 사용되는 Chai, Jasmine 등에서는 좀 더 자연어에 가까운 [BDD(Behavior-driven development](https://en.wikipedia.org/wiki/Behavior-driven_development) 방식의 API가 사용된다. 또한 대부분의 단언 라이브러리들은 사용자들이 필요에 따라 자신만의 단언을 추가해서 사용할 수 있는 플러그인 확장 기능을 제공한다.

#### 테스트 더블(test double)

실제 객체 대신 테스트를 위해 동작하는 객체를 말한다. 주로 분리된(isolated) 단위테스트를 위해 외부 의존성을 임의로 주입하기 위해서 사용한다. 필요에 따라 스파이(spy), 스텁(stub), 목(mock) 등의 다양한 테스트 더블을 사용할 수있고, 이들을 쉽게 만들 수 있게 도와주는 라이브러리를 테스트 더블 라이브러리라고 한다. 단언과 마찬가지로 테스트더블을 위한 함수들도 테스트 프레임워크에서 기본제공되는 경우가 대부분이고, Mocha의 경우에만 Sinon.JS 등의 별도 라이브러리를 사용하도록 권장하고 있다. 

## 테스트 실행환경

### 브라우저

실제 브라우저에서 실행해서 테스트코드를 실행하는 방식을 의미한다. E2E 테스트도구들을 제외한다면 현재로선 Karma를 사용하는 것이 유일한 방법이다. Karma는 테스트러너의 역할만 하기 때문에 별도의 프레임워크가 추가로 필요하며, 보통 Jasmine을 사용하기를 권장한다.

#### 장점

- 실제 브라우저 환경에서 테스트하기 때문에 브라우저의 모든 기능(네트워크 IO, 렌더링 엔진 등)을 활용해서 테스트할 수 있다
- Selenium 등의 도구를 사용하면 동일한 테스트코드를 다양한 환경(운영체제, 브라우저) 테스트를 실행할 수 있어서 브라우저 호환성 및 기기 환경에 대한 테스트도 진행할 수 있다.

#### 단점

- 브라우저의 프로세스가 Node.js의 프로세스보다 무겁기 때문에 테스트 초기 구동속도가 더 느리다.
- 브라우저라는 별도의 어플리케이션을 추가로 실행해야 하기 때문에 실행을 위한 브라우저 런처(launcher) 등을 추가로 설치해줘야 하는 번거로움이 있다.
- 크로스 브라우징 테스트 등을 위해 별도의 환경을 구축하고 유지보수하는 비용도 무시할 수 없다.

단점 극복을 위해 개발단계에선 헤드리스 브라우저(Headless browser)를 사용해서 빠른 피드백을 얻을 수 있게 하고, 개발 완료 혹은 배포 시에만 CI서버와 통합해서 브라우징 테스트 하는 방식을 권장한다. 또한 Browser Stack이나 Sauce Lab 등의 외부 서비스를 사용하면 크로스 브라우징을 위한 환경을 직접 구축할 필요 없이 Karma와 손쉽게 연동하여 사용할 수 있다.

### Node.js

Node.js 환경에서 테스트코드를 실행하는 방식을 의미한다. 최근 가장 많이 쓰이는 도구는 Mocha와 Jest이다. 

#### 장점

- 테스트러너와 프레임워크가 통합되어 있어 설치 및 실행이 비교적 간단하다.
- Node.js프로세스가 브라우저의 프로세스에 비해 훨씬 가볍기 때문에 실행속도가 빠르다.
- 브라우저에선 아직 모듈 단위의 테스트를 실행하기 어려워 webpack 등의 번들러를 사용해야 하는 제약이 있는데, Node.js 환경에선 개별 프로세스에서 원하는 모듈만 가져와서(import) 테스트할 수 있기 때문에 훨씬 간단하고 안전한 방식으로 테스트할 수 있다.

#### 단점

- 브라우저의 모든 API를 제대로 활용할 수 없다. Node.js엔 브라우저가 제공하는 DOM이나 BOM 등의 API가 없기 때문이다.

이 문제를 해결하기 위해 jsdom과 같은 라이브러리를 사용해서 브라우저 환경을 가상으로 구현하는 방식을 사용하고 있지만 실제 브라우저의 동작을 100% 구현하진 못해서 많은 제약이 있다. (렌더링 엔진을 갖고 있지 않아서 UI요소의 레이아웃에 대한 테스트를 할 수 없고, 내비게이션 관련 동작도 사용할 수 없다. 크로스 브라우징에 대한 테스트도 불가하다)